'use client'\nimport { useEffect, useState } from 'react'\nimport { useRouter } from 'next/navigation'\nimport { useAuth } from '@/contexts/AuthContext'\nimport DashboardLayout from '@/components/DashboardLayout'\n\ninterface WaitlistSubscription {\n  id: string\n  email: string\n  productId: string\n  productName: string\n  variantId?: string\n  variantSku?: string\n  userId?: string\n  userName?: string\n  isActive: boolean\n  createdAt: Date\n  expectedRestockDate?: Date\n}\n\ninterface WaitlistAnalytics {\n  totalSubscriptions: number\n  activeSubscriptions: number\n  subscriptionsByProduct: Array<{\n    productId: string\n    productName: string\n    count: number\n  }>\n}\n\nexport default function AdminWaitlistDashboard() {\n  const { user } = useAuth()\n  const router = useRouter()\n  const [subscriptions, setSubscriptions] = useState<WaitlistSubscription[]>([])\n  const [analytics, setAnalytics] = useState<WaitlistAnalytics | null>(null)\n  const [loading, setLoading] = useState(true)\n  const [error, setError] = useState<string | null>(null)\n  const [filterProduct, setFilterProduct] = useState('all')\n  const [sortBy, setSortBy] = useState('date')\n\n  useEffect(() => {\n    if (!user) {\n      router.push('/login')\n      return\n    }\n    \n    if (!user.isAdmin) {\n      router.push('/account')\n      return\n    }\n\n    fetchWaitlistData()\n  }, [user, router])\n\n  const fetchWaitlistData = async () => {\n    try {\n      setLoading(true)\n      const response = await fetch('/api/admin/waitlists')\n      \n      if (response.ok) {\n        const data = await response.json()\n        setSubscriptions(data.subscriptions || [])\n        setAnalytics(data.analytics || null)\n      } else {\n        setError('Fehler beim Laden der Wartelisten-Daten')\n      }\n    } catch (error) {\n      console.error('Error fetching waitlist data:', error)\n      setError('Fehler beim Laden der Wartelisten-Daten')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const handleSendNotification = async (productId: string, variantId?: string) => {\n    if (!confirm('Möchten Sie Benachrichtigungen für dieses Produkt senden?')) {\n      return\n    }\n\n    try {\n      const response = await fetch('/api/notifications/restock', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify({\n          productId,\n          variantId,\n          trigger: 'manual'\n        })\n      })\n\n      if (response.ok) {\n        const data = await response.json()\n        alert(`${data.notificationsSent} Benachrichtigungen gesendet`)\n      } else {\n        const data = await response.json()\n        alert(data.error || 'Fehler beim Senden der Benachrichtigungen')\n      }\n    } catch (error) {\n      console.error('Error sending notifications:', error)\n      alert('Fehler beim Senden der Benachrichtigungen')\n    }\n  }\n\n  const formatDate = (date: Date) => {\n    return new Intl.DateTimeFormat('de-DE', {\n      year: 'numeric',\n      month: 'short',\n      day: 'numeric',\n      hour: '2-digit',\n      minute: '2-digit'\n    }).format(date)\n  }\n\n  // Filter and sort subscriptions\n  const filteredSubscriptions = subscriptions\n    .filter(subscription => {\n      if (filterProduct === 'all') return true\n      return subscription.productId === filterProduct\n    })\n    .sort((a, b) => {\n      switch (sortBy) {\n        case 'date':\n          return new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()\n        case 'product':\n          return a.productName.localeCompare(b.productName)\n        case 'email':\n          return a.email.localeCompare(b.email)\n        default:\n          return 0\n      }\n    })\n\n  const uniqueProducts = Array.from(\n    new Set(subscriptions.map(s => s.productId))\n  ).map(productId => {\n    const subscription = subscriptions.find(s => s.productId === productId)\n    return {\n      id: productId,\n      name: subscription?.productName || 'Unknown Product'\n    }\n  })\n\n  if (!user || !user.isAdmin) {\n    return null\n  }\n\n  return (\n    <DashboardLayout>\n      <div className=\"space-y-6\">\n        {/* Header */}\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h1 className=\"text-2xl font-bold text-gray-900\">Wartelisten verwalten</h1>\n            <p className=\"text-gray-600 mt-1\">\n              Übersicht und Verwaltung aller Wartelisten-Abonnements\n            </p>\n          </div>\n          <div className=\"flex items-center space-x-3\">\n            <button\n              onClick={fetchWaitlistData}\n              className=\"bg-white border border-gray-300 rounded-lg px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors\"\n            >\n              <svg className=\"w-4 h-4 mr-2 inline\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15\" />\n              </svg>\n              Aktualisieren\n            </button>\n          </div>\n        </div>\n\n        {/* Analytics Cards */}\n        {analytics && (\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\n            <div className=\"bg-white rounded-lg shadow-sm p-6\">\n              <div className=\"flex items-center\">\n                <div className=\"w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center\">\n                  <svg className=\"w-6 h-6 text-blue-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 17h5l-5 5-5-5h5v-5a7.5 7.5 0 1 0-15 0v5h5l-5 5-5-5h5V7a12 12 0 1 1 24 0v10z\" />\n                  </svg>\n                </div>\n                <div className=\"ml-4\">\n                  <p className=\"text-sm font-medium text-gray-600\">Gesamt</p>\n                  <p className=\"text-2xl font-semibold text-gray-900\">{analytics.totalSubscriptions}</p>\n                </div>\n              </div>\n            </div>\n\n            <div className=\"bg-white rounded-lg shadow-sm p-6\">\n              <div className=\"flex items-center\">\n                <div className=\"w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center\">\n                  <svg className=\"w-6 h-6 text-green-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                  </svg>\n                </div>\n                <div className=\"ml-4\">\n                  <p className=\"text-sm font-medium text-gray-600\">Aktiv</p>\n                  <p className=\"text-2xl font-semibold text-gray-900\">{analytics.activeSubscriptions}</p>\n                </div>\n              </div>\n            </div>\n\n            <div className=\"bg-white rounded-lg shadow-sm p-6\">\n              <div className=\"flex items-center\">\n                <div className=\"w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center\">\n                  <svg className=\"w-6 h-6 text-purple-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4\" />\n                  </svg>\n                </div>\n                <div className=\"ml-4\">\n                  <p className=\"text-sm font-medium text-gray-600\">Produkte</p>\n                  <p className=\"text-2xl font-semibold text-gray-900\">{analytics.subscriptionsByProduct.length}</p>\n                </div>\n              </div>\n            </div>\n          </div>\n        )}\n\n        {/* Popular Products */}\n        {analytics && analytics.subscriptionsByProduct.length > 0 && (\n          <div className=\"bg-white rounded-lg shadow-sm p-6\">\n            <h3 className=\"text-lg font-semibold text-gray-900 mb-4\">Beliebteste Produkte</h3>\n            <div className=\"space-y-3\">\n              {analytics.subscriptionsByProduct.slice(0, 5).map((product, index) => (\n                <div key={product.productId} className=\"flex items-center justify-between py-2\">\n                  <div className=\"flex items-center\">\n                    <span className=\"inline-flex items-center justify-center w-6 h-6 bg-primary-100 text-primary-600 rounded-full text-xs font-semibold mr-3\">\n                      {index + 1}\n                    </span>\n                    <span className=\"font-medium text-gray-900\">{product.productName}</span>\n                  </div>\n                  <div className=\"flex items-center space-x-3\">\n                    <span className=\"text-sm text-gray-600\">{product.count} Abonnements</span>\n                    <button\n                      onClick={() => handleSendNotification(product.productId)}\n                      className=\"text-primary-600 hover:text-primary-700 text-sm font-medium\"\n                    >\n                      Benachrichtigen\n                    </button>\n                  </div>\n                </div>\n              ))}\n            </div>\n          </div>\n        )}\n\n        {/* Filters */}\n        <div className=\"bg-white rounded-lg shadow-sm p-6\">\n          <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-4 sm:space-y-0\">\n            <div className=\"flex items-center space-x-4\">\n              <div>\n                <label className=\"block text-sm font-medium text-gray-700 mb-1\">Produkt</label>\n                <select\n                  value={filterProduct}\n                  onChange={(e) => setFilterProduct(e.target.value)}\n                  className=\"border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500\"\n                >\n                  <option value=\"all\">Alle Produkte</option>\n                  {uniqueProducts.map((product) => (\n                    <option key={product.id} value={product.id}>\n                      {product.name}\n                    </option>\n                  ))}\n                </select>\n              </div>\n              \n              <div>\n                <label className=\"block text-sm font-medium text-gray-700 mb-1\">Sortieren</label>\n                <select\n                  value={sortBy}\n                  onChange={(e) => setSortBy(e.target.value)}\n                  className=\"border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500\"\n                >\n                  <option value=\"date\">Datum</option>\n                  <option value=\"product\">Produkt</option>\n                  <option value=\"email\">E-Mail</option>\n                </select>\n              </div>\n            </div>\n          </div>\n        </div>\n\n        {/* Subscriptions Table */}\n        <div className=\"bg-white rounded-lg shadow-sm overflow-hidden\">\n          {loading ? (\n            <div className=\"flex items-center justify-center py-12\">\n              <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600\"></div>\n              <span className=\"ml-2 text-gray-600\">Wird geladen...</span>\n            </div>\n          ) : error ? (\n            <div className=\"text-center py-12\">\n              <div className=\"text-red-600 mb-4\">\n                <svg className=\"w-12 h-12 mx-auto\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                </svg>\n              </div>\n              <p className=\"text-gray-600 mb-4\">{error}</p>\n              <button\n                onClick={fetchWaitlistData}\n                className=\"bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg transition-colors\"\n              >\n                Erneut versuchen\n              </button>\n            </div>\n          ) : filteredSubscriptions.length === 0 ? (\n            <div className=\"text-center py-12\">\n              <div className=\"text-gray-400 mb-4\">\n                <svg className=\"w-16 h-16 mx-auto\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1} d=\"M15 17h5l-5 5-5-5h5v-5a7.5 7.5 0 1 0-15 0v5h5l-5 5-5-5h5V7a12 12 0 1 1 24 0v10z\" />\n                </svg>\n              </div>\n              <h3 className=\"text-lg font-medium text-gray-900 mb-2\">Keine Wartelisten-Abonnements gefunden</h3>\n              <p className=\"text-gray-600\">\n                {filterProduct === 'all' \n                  ? 'Es sind noch keine Wartelisten-Abonnements vorhanden.'\n                  : 'Keine Abonnements für das ausgewählte Produkt gefunden.'\n                }\n              </p>\n            </div>\n          ) : (\n            <div className=\"overflow-x-auto\">\n              <table className=\"min-w-full divide-y divide-gray-200\">\n                <thead className=\"bg-gray-50\">\n                  <tr>\n                    <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\n                      Kunde\n                    </th>\n                    <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\n                      Produkt\n                    </th>\n                    <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\n                      Status\n                    </th>\n                    <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\n                      Datum\n                    </th>\n                    <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\n                      Aktionen\n                    </th>\n                  </tr>\n                </thead>\n                <tbody className=\"bg-white divide-y divide-gray-200\">\n                  {filteredSubscriptions.map((subscription) => (\n                    <tr key={subscription.id} className=\"hover:bg-gray-50\">\n                      <td className=\"px-6 py-4\">\n                        <div>\n                          <div className=\"text-sm font-medium text-gray-900\">{subscription.email}</div>\n                          {subscription.userName && (\n                            <div className=\"text-sm text-gray-500\">{subscription.userName}</div>\n                          )}\n                        </div>\n                      </td>\n                      <td className=\"px-6 py-4\">\n                        <div>\n                          <div className=\"text-sm font-medium text-gray-900\">{subscription.productName}</div>\n                          {subscription.variantSku && (\n                            <div className=\"text-sm text-gray-500\">SKU: {subscription.variantSku}</div>\n                          )}\n                          {subscription.expectedRestockDate && (\n                            <div className=\"text-xs text-blue-600 mt-1\">\n                              Erwartet: {formatDate(new Date(subscription.expectedRestockDate))}\n                            </div>\n                          )}\n                        </div>\n                      </td>\n                      <td className=\"px-6 py-4 whitespace-nowrap\">\n                        <span className={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${\n                          subscription.isActive \n                            ? 'bg-green-100 text-green-800' \n                            : 'bg-gray-100 text-gray-800'\n                        }`}>\n                          {subscription.isActive ? 'Aktiv' : 'Inaktiv'}\n                        </span>\n                      </td>\n                      <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500\">\n                        {formatDate(new Date(subscription.createdAt))}\n                      </td>\n                      <td className=\"px-6 py-4 whitespace-nowrap text-sm font-medium\">\n                        <button\n                          onClick={() => handleSendNotification(subscription.productId, subscription.variantId)}\n                          className=\"text-primary-600 hover:text-primary-700 font-medium\"\n                        >\n                          Benachrichtigen\n                        </button>\n                      </td>\n                    </tr>\n                  ))}\n                </tbody>\n              </table>\n            </div>\n          )}\n        </div>\n      </div>\n    </DashboardLayout>\n  )\n}\n"